#!/usr/bin/env python3
"""
Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ ÑĞ±Ğ¾Ñ€ĞºĞ¸ standalone Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Roland SP-404 MKII Automation
"""

import os
import sys
import subprocess
import shutil
from pathlib import Path

def run_command(cmd, description):
    """Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ Ğ¸ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚"""
    print(f"\nğŸ”„ {description}...")
    print(f"ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°: {' '.join(cmd)}")
    
    try:
        result = subprocess.run(cmd, check=True, capture_output=True, text=True)
        print(f"âœ… {description} Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾")
        if result.stdout:
            print("Ğ’Ñ‹Ğ²Ğ¾Ğ´:", result.stdout)
        return True
    except subprocess.CalledProcessError as e:
        print(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ {description.lower()}")
        print("ĞšĞ¾Ğ´ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸:", e.returncode)
        if e.stdout:
            print("Ğ’Ñ‹Ğ²Ğ¾Ğ´:", e.stdout)
        if e.stderr:
            print("ĞÑˆĞ¸Ğ±ĞºĞ°:", e.stderr)
        return False

def main():
    """ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ ÑĞ±Ğ¾Ñ€ĞºĞ¸"""
    print("ğŸš€ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Roland SP-404 MKII Automation App")
    print("=" * 50)
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ PyInstaller
    try:
        import PyInstaller
        print(f"âœ… PyInstaller Ğ½Ğ°Ğ¹Ğ´ĞµĞ½: Ğ²ĞµÑ€ÑĞ¸Ñ {PyInstaller.__version__}")
    except ImportError:
        print("âŒ PyInstaller Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ: pip install pyinstaller")
        return 1
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ spec Ñ„Ğ°Ğ¹Ğ»Ğ°
    spec_file = Path("roland_sp404.spec")
    if not spec_file.exists():
        print("âŒ Ğ¤Ğ°Ğ¹Ğ» roland_sp404.spec Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")
        return 1
    
    # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğµ ÑĞ±Ğ¾Ñ€ĞºĞ¸
    print("\nğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ñ… ÑĞ±Ğ¾Ñ€Ğ¾Ğº...")
    dirs_to_clean = ["build", "dist", "__pycache__"]
    for dir_name in dirs_to_clean:
        if Path(dir_name).exists():
            shutil.rmtree(dir_name)
            print(f"Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ° Ğ¿Ğ°Ğ¿ĞºĞ°: {dir_name}")
    
    # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ
    if not run_command([
        "python3", "-m", "PyInstaller", 
        "--clean", 
        "roland_sp404.spec"
    ], "Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ"):
        return 1
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
    app_path = Path("dist/Roland SP-404 MKII Automation.app")
    if app_path.exists():
        print(f"\nğŸ‰ ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ¾!")
        print(f"ğŸ“ ĞŸÑƒÑ‚ÑŒ: {app_path.absolute()}")
        print(f"ğŸ“Š Ğ Ğ°Ğ·Ğ¼ĞµÑ€: {get_folder_size(app_path)}")
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ°Ñ€Ñ…Ğ¸Ğ² Ğ´Ğ»Ñ Ñ€Ğ°ÑĞ¿Ñ€Ğ¾ÑÑ‚Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ
        print("\nğŸ“¦ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ° Ğ´Ğ»Ñ Ñ€Ğ°ÑĞ¿Ñ€Ğ¾ÑÑ‚Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ...")
        archive_name = "Roland_SP404_Automation_macOS.zip"
        if run_command([
            "zip", "-r", archive_name, 
            str(app_path)
        ], "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ°"):
            print(f"âœ… ĞÑ€Ñ…Ğ¸Ğ² ÑĞ¾Ğ·Ğ´Ğ°Ğ½: {archive_name}")
            print(f"ğŸ“Š Ğ Ğ°Ğ·Ğ¼ĞµÑ€ Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ°: {get_file_size(archive_name)}")
        
        print("\nğŸ¯ Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾! ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾:")
        print("1. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ´Ğ²Ğ¾Ğ¹Ğ½Ñ‹Ğ¼ ĞºĞ»Ğ¸ĞºĞ¾Ğ¼")
        print("2. ĞŸĞµÑ€ĞµÑ‚Ğ°Ñ‰Ğ¸Ñ‚ÑŒ Ğ² Ğ¿Ğ°Ğ¿ĞºÑƒ Applications")
        print("3. Ğ Ğ°ÑĞ¿Ñ€Ğ¾ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· Ğ°Ñ€Ñ…Ğ¸Ğ²")
        
        return 0
    else:
        print("âŒ ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ½Ğµ Ğ±Ñ‹Ğ»Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¾")
        return 1

def get_folder_size(folder_path):
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ¿Ğ°Ğ¿ĞºĞ¸ Ğ² ÑƒĞ´Ğ¾Ğ±Ğ½Ğ¾Ğ¼ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ"""
    total_size = 0
    for dirpath, dirnames, filenames in os.walk(folder_path):
        for filename in filenames:
            filepath = os.path.join(dirpath, filename)
            if os.path.exists(filepath):
                total_size += os.path.getsize(filepath)
    
    return format_size(total_size)

def get_file_size(file_path):
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ² ÑƒĞ´Ğ¾Ğ±Ğ½Ğ¾Ğ¼ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ"""
    if os.path.exists(file_path):
        return format_size(os.path.getsize(file_path))
    return "0 B"

def format_size(size_bytes):
    """Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ² Ğ±Ğ°Ğ¹Ñ‚Ğ°Ñ… Ğ² ÑƒĞ´Ğ¾Ğ±Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚"""
    if size_bytes == 0:
        return "0 B"
    
    size_names = ["B", "KB", "MB", "GB"]
    i = 0
    while size_bytes >= 1024 and i < len(size_names) - 1:
        size_bytes /= 1024.0
        i += 1
    
    return f"{size_bytes:.1f} {size_names[i]}"

if __name__ == "__main__":
    sys.exit(main())
